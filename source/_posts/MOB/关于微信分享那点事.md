---
title: 关于微信那点事
date: 2017-08-31T13:53:55.000Z
tags: [微信]
categories: 微信
---

--------------------------------------------------------------------------------

<!-- more -->

## 微信分享

今天遇到微信分享输入了""，而在页面中直接用php模板语言输出进`js`中报错，

```
输入: titlte "天空之城"梦想起航

js: var title = '{$info.title}';
```

但是微信自动把""闭合，不允许这样输出导致js出错，进而微信分享报错

解决: 在页面中输出出来所有的php模板语言然后js获取

html

```html
<!-- 微信分享 -->
<div id="wx-share" wx-title="{$info.chan_name}" wx-desc="{$info.affiche}" wx-link="{$info.redirect_url}" wx-imgUrl="{$info.face_url}"></div>
```

js

```javascript
<!-- 配置微信 -->
<script src="https://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>

wx.config({
  debug: false,
  appId: "{$signPackage.appId}",
  timestamp: "{$signPackage.timestamp}",
  nonceStr: "{$signPackage.nonceStr}",
  signature: "{$signPackage.signature}",
  jsApiList: ["onMenuShareTimeline", "onMenuShareAppMessage", "onMenuShareQQ", "chooseImage", "uploadImage"]
});
wx.ready(function () {
    var title = $("#wx-share").attr("wx-title") || "";
    title = title.replace(/\s/, "").replace(" ", "");
    var descript = $("#wx-share").attr("wx-desc");
    var shareurl = $("#wx-share").attr("wx-link");
    var imgurl = $("#wx-share").attr("wx-imgUrl");
    if (descript == '') {
        descript = title;
    }
    //分享给朋友
    wx.onMenuShareAppMessage({
        title: title, //  分享标题
        desc: descript, //  分享链接
        link: shareurl, // 分享图标
        imgUrl: imgurl,
        type: 'link',
        dataUrl: '',
        success: function () {
            $(this).minTipsBox({
                tipsContent: "分享成功",
                tipsTime: 1
            }); // 用户确认分享后执行的回调函数
            //window.location.reload(true);
        },
        cancel: function () {
            // 用户取消分享后执行的回调函数
        }
    });
    //分享到朋友圈
    wx.onMenuShareTimeline({
        title: title, // 分享标题
        link: shareurl, // 分享链接
        imgUrl: imgurl, // 分享图标
        success: function () {
            $(this).minTipsBox({
                tipsContent: "分享成功",
                tipsTime: 1
            }); // 用户确认分享后执行的回调函数
            //window.location.reload(true);
        },
        cancel: function () {
            // 用户取消分享后执行的回调函数
        }
    });
    //分享到QQ
    wx.onMenuShareQQ({
        title: title, // 分享标题
        desc: descript, // 分享描述
        link: shareurl, // 分享链接
        imgUrl: imgurl, // 分享图标
        success: function () {
            $(this).minTipsBox({
                tipsContent: "分享成功",
                tipsTime: 1
            }); // 用户确认分享后执行的回调函数
            //window.location.reload(true);
        },
        cancel: function () {
            // 用户取消分享后执行的回调函数
        }
    });
    //分享到腾讯微博
    wx.onMenuShareWeibo({
        title: title, // 分享标题
        desc: descript, // 分享描述
        link: shareurl, // 分享链接
        imgUrl: imgurl, // 分享图标
        success: function () {
            $(this).minTipsBox({
                tipsContent: "分享成功",
                tipsTime: 1
            }); // 用户确认分享后执行的回调函数
            //window.location.reload(true);
        },
        cancel: function () {
            // 用户取消分享后执行的回调函数
        }
    });

    //分享到QQ空间
    wx.onMenuShareQZone({
        title: title, // 分享标题
        desc: descript, // 分享描述
        link: shareurl, // 分享链接
        imgUrl: imgurl, // 分享图标
        success: function () {
            $(this).minTipsBox({
                tipsContent: "分享成功",
                tipsTime: 1
            }); // 用户确认分享后执行的回调函数
            //window.location.reload(true);
        },
        cancel: function () {
            // 用户取消分享后执行的回调函数
        }
    });
});
wx.error(function(res) {
  console.log(res.errMsg);
});
```

## 微信支付

```javascript
// 支付
$('.xx').click(function(event) {
  $.ajax({
    url: "",
    type: "POST", //请求方式 GET
    async: false,
    data: {
      'id': '111'
    },
    dataType: "json",
    success: function(req) {
      if (req.zt == 'ok') {
        jsApiParameters = JSON.parse(req.jsApiParameters);
        alert(JSON.stringify(jsApiParameters));
        callpay();
      } else {
        ok_tips(req.err);
      }
    },
    error: function(req) {
      console.log(req);
    }
  });
});

//调用微信JS api 支付
// 接受一个jsApiParameters的参数对象
function jsApiCall() {
  WeixinJSBridge.invoke(
    'getBrandWCPayRequest', jsApiParameters,
    function(res) {
      if (res.err_msg == "get_brand_wcpay_request:ok") {
        ok_tips('支付成功');
        $('.ex-paytrue').text('已报名').css('background', '#a6a6a6');

      } else {
        ok_tips('支付失败');
      }
    }
  );
}

function callpay() {
  if (typeof WeixinJSBridge == "undefined") {
    if (document.addEventListener) {
      document.addEventListener('WeixinJSBridgeReady', jsApiCall, false);
    } else if (document.attachEvent) {
      document.attachEvent('WeixinJSBridgeReady', jsApiCall);
      document.attachEvent('onWeixinJSBridgeReady', jsApiCall);
    }
  } else {
    jsApiCall();
  }
}
```
